<!-- Page Header -->
<div class="page-header">
    <div class="container-fluid">
        <h1>
            <i class="fas fa-chart-bar"></i>
            Reportes y Estadísticas
        </h1>
        <p>Visualiza y analiza información detallada de tu negocio</p>
    </div>
</div>

<div class="container-fluid">
    <!-- Selector de Tipo de Reporte -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Tipo de Reporte</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-12">
                    <div class="btn-group flex-wrap" role="group">
                        <!-- REPORTES DE COMPRAS -->
                        <button type="button" class="btn btn-outline-primary"
                            [class.active]="tipoReporte === 'compras-fecha'"
                            (click)="cambiarTipoReporte('compras-fecha')">
                            <i class="fas fa-calendar-alt me-2"></i>Compras por Fecha
                        </button>
                        <button type="button" class="btn btn-outline-primary"
                            [class.active]="tipoReporte === 'compras-proveedor'"
                            (click)="cambiarTipoReporte('compras-proveedor')">
                            <i class="fas fa-truck me-2"></i>Compras por Proveedor
                        </button>
                        <button type="button" class="btn btn-outline-primary"
                            [class.active]="tipoReporte === 'compras-mensual'"
                            (click)="cambiarTipoReporte('compras-mensual')">
                            <i class="fas fa-chart-line me-2"></i>Compras Mensuales
                        </button>

                        <!-- REPORTES DE VENTAS -->
                        <button type="button" class="btn btn-outline-success"
                            [class.active]="tipoReporte === 'ventas-fecha'"
                            (click)="cambiarTipoReporte('ventas-fecha')">
                            <i class="fas fa-calendar-check me-2"></i>Ventas por Fecha
                        </button>
                        <button type="button" class="btn btn-outline-success"
                            [class.active]="tipoReporte === 'ventas-cliente'"
                            (click)="cambiarTipoReporte('ventas-cliente')">
                            <i class="fas fa-users me-2"></i>Ventas por Cliente
                        </button>
                        <button type="button" class="btn btn-outline-success"
                            [class.active]="tipoReporte === 'ventas-mensual'"
                            (click)="cambiarTipoReporte('ventas-mensual')">
                            <i class="fas fa-chart-area me-2"></i>Ventas Mensuales
                        </button>

                        <!-- REPORTES DE INVENTARIO -->
                        <button type="button" class="btn btn-outline-info" [class.active]="tipoReporte === 'inventario'"
                            (click)="cambiarTipoReporte('inventario')">
                            <i class="fas fa-boxes me-2"></i>Inventario Completo
                        </button>
                        <button type="button" class="btn btn-outline-warning"
                            [class.active]="tipoReporte === 'stock-bajo'" (click)="cambiarTipoReporte('stock-bajo')">
                            <i class="fas fa-exclamation-triangle me-2"></i>Stock Bajo
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros para COMPRAS -->
    <div class="card mb-4" *ngIf="tipoReporte.startsWith('compras')">
        <div class="card-header bg-light">
            <h6 class="mb-0"><i class="fas fa-sliders-h me-2"></i>Filtros de Compras</h6>
        </div>
        <div class="card-body">
            <form [formGroup]="formFiltros">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Fecha Inicio</label>
                        <input type="date" class="form-control" formControlName="fechaInicio">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Fecha Fin</label>
                        <input type="date" class="form-control" formControlName="fechaFin">
                    </div>
                    <div class="col-md-3" *ngIf="tipoReporte === 'compras-fecha'">
                        <label class="form-label">Proveedor</label>
                        <select class="form-select" formControlName="proveedor">
                            <option value="todos">Todos los proveedores</option>
                            <option *ngFor="let proveedor of listProveedores" [value]="proveedor.razon_social">
                                {{proveedor.razon_social}}
                            </option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-primary me-2" (click)="aplicarFiltros()">
                            <i class="fas fa-search me-2"></i>Aplicar
                        </button>
                        <button class="btn btn-secondary" (click)="limpiarFiltros()">
                            <i class="fas fa-eraser me-2"></i>Limpiar
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Filtros para VENTAS -->
    <div class="card mb-4" *ngIf="tipoReporte.startsWith('ventas')">
        <div class="card-header bg-light">
            <h6 class="mb-0"><i class="fas fa-sliders-h me-2"></i>Filtros de Ventas</h6>
        </div>
        <div class="card-body">
            <form [formGroup]="formFiltros">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Fecha Inicio</label>
                        <input type="date" class="form-control" formControlName="fechaInicio">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Fecha Fin</label>
                        <input type="date" class="form-control" formControlName="fechaFin">
                    </div>
                    <div class="col-md-3" *ngIf="tipoReporte === 'ventas-fecha'">
                        <label class="form-label">Cliente</label>
                        <select class="form-select" formControlName="cliente">
                            <option value="todos">Todos los clientes</option>
                            <option *ngFor="let cliente of listClientes" [value]="cliente.id">
                                {{cliente.nombre}} {{cliente.apellido_pa}} {{cliente.apellido_ma}}
                            </option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-success me-2" (click)="aplicarFiltros()">
                            <i class="fas fa-search me-2"></i>Aplicar
                        </button>
                        <button class="btn btn-secondary" (click)="limpiarFiltros()">
                            <i class="fas fa-eraser me-2"></i>Limpiar
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Filtro de Stock Mínimo -->
    <div class="card mb-4" *ngIf="tipoReporte === 'stock-bajo'">
        <div class="card-header bg-light">
            <h6 class="mb-0"><i class="fas fa-sliders-h me-2"></i>Configuración</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">Stock Mínimo</label>
                    <input type="number" class="form-control" [(ngModel)]="stockMinimo"
                        (change)="generarReporteStockBajo()" min="0">
                    <small class="text-muted">Productos con stock menor o igual a este valor</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Botones de Acción -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-end">
                <button class="btn btn-success me-2" (click)="exportarReporte()">
                    <i class="fas fa-file-excel me-2"></i>Exportar a Excel
                </button>
                <button class="btn btn-info" (click)="imprimirReporte()">
                    <i class="fas fa-print me-2"></i>Imprimir
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== REPORTES DE COMPRAS ==================== -->

    <!-- REPORTE: Compras por Fecha -->
    <div *ngIf="tipoReporte === 'compras-fecha'">
        <!-- Estadísticas -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card text-white bg-primary">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h4 class="mb-0">{{totalCompras}}</h4>
                                <small>Total de Compras</small>
                            </div>
                            <i class="fas fa-shopping-cart fa-3x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card text-white bg-danger">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h4 class="mb-0">S/. {{totalMontoCompras | number:'1.2-2'}}</h4>
                                <small>Monto Total</small>
                            </div>
                            <i class="fas fa-dollar-sign fa-3x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de Compras -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-list me-2"></i>Detalle de Compras</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th class="text-center">ID</th>
                                <th>Proveedor</th>
                                <th class="text-center">Fecha</th>
                                <th class="text-end">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let compra of comprasFiltradas">
                                <td class="text-center"><strong>#{{compra.id}}</strong></td>
                                <td><i class="fas fa-truck text-primary me-2"></i>{{compra.proveedor}}</td>
                                <td class="text-center">{{compra.fecha | date:'dd/MM/yyyy HH:mm'}}</td>
                                <td class="text-end"><strong class="text-danger">S/. {{compra.total |
                                        number:'1.2-2'}}</strong></td>
                            </tr>
                            <tr *ngIf="comprasFiltradas.length === 0">
                                <td colspan="4" class="text-center text-muted py-4">
                                    <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                                    <p class="mb-0">No hay compras en el rango seleccionado</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- REPORTE: Compras por Proveedor -->
    <div *ngIf="tipoReporte === 'compras-proveedor'">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-truck me-2"></i>Compras por Proveedor</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Proveedor</th>
                                <th class="text-center">Total Compras</th>
                                <th class="text-end">Monto Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let reporte of reporteProveedores">
                                <td><i class="fas fa-building text-primary me-2"></i>{{reporte.proveedor}}</td>
                                <td class="text-center"><span class="badge bg-info">{{reporte.totalCompras}}</span></td>
                                <td class="text-end"><strong class="text-danger">S/. {{reporte.montoTotal |
                                        number:'1.2-2'}}</strong></td>
                            </tr>
                            <tr *ngIf="reporteProveedores.length === 0">
                                <td colspan="3" class="text-center text-muted py-4">
                                    <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                                    <p class="mb-0">No hay datos disponibles</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- REPORTE: Compras Mensuales -->
    <div *ngIf="tipoReporte === 'compras-mensual'">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Compras por Mes</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Mes</th>
                                <th class="text-center">Total Compras</th>
                                <th class="text-end">Monto Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let reporte of reporteMensualCompras">
                                <td><i class="fas fa-calendar text-primary me-2"></i>{{reporte.mes}}</td>
                                <td class="text-center"><span class="badge bg-info">{{reporte.totalCompras}}</span></td>
                                <td class="text-end"><strong class="text-danger">S/. {{reporte.montoTotal |
                                        number:'1.2-2'}}</strong></td>
                            </tr>
                            <tr *ngIf="reporteMensualCompras.length === 0">
                                <td colspan="3" class="text-center text-muted py-4">
                                    <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                                    <p class="mb-0">No hay datos disponibles</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== REPORTES DE VENTAS ==================== -->

    <!-- REPORTE: Ventas por Fecha -->
    <div *ngIf="tipoReporte === 'ventas-fecha'">
        <!-- Estadísticas -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card text-white bg-success">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h4 class="mb-0">{{totalVentas}}</h4>
                                <small>Total de Ventas</small>
                            </div>
                            <i class="fas fa-shopping-bag fa-3x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card text-white bg-info">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h4 class="mb-0">S/. {{totalMontoVentas | number:'1.2-2'}}</h4>
                                <small>Monto Total</small>
                            </div>
                            <i class="fas fa-dollar-sign fa-3x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de Ventas -->
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-list me-2"></i>Detalle de Ventas</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th class="text-center">ID</th>
                                <th>Cliente</th>
                                <th class="text-center">Fecha</th>
                                <th class="text-end">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let venta of ventasFiltradas">
                                <td class="text-center"><strong>#{{venta.id}}</strong></td>
                                <td><i class="fas fa-user text-success me-2"></i>{{obtenerNombreCliente(venta.cliente)}}
                                </td>
                                <td class="text-center">{{venta.fecha | date:'dd/MM/yyyy HH:mm'}}</td>
                                <td class="text-end"><strong class="text-success">S/. {{venta.total |
                                        number:'1.2-2'}}</strong></td>
                            </tr>
                            <tr *ngIf="ventasFiltradas.length === 0">
                                <td colspan="4" class="text-center text-muted py-4">
                                    <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                                    <p class="mb-0">No hay ventas en el rango seleccionado</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- REPORTE: Ventas por Cliente -->
    <div *ngIf="tipoReporte === 'ventas-cliente'">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-users me-2"></i>Ventas por Cliente</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Cliente</th>
                                <th class="text-center">Total Ventas</th>
                                <th class="text-end">Monto Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let reporte of reporteClientes">
                                <td><i class="fas fa-user-circle text-success me-2"></i>{{reporte.cliente}}</td>
                                <td class="text-center"><span class="badge bg-success">{{reporte.totalVentas}}</span>
                                </td>
                                <td class="text-end"><strong class="text-success">S/. {{reporte.montoTotal |
                                        number:'1.2-2'}}</strong></td>
                            </tr>
                            <tr *ngIf="reporteClientes.length === 0">
                                <td colspan="3" class="text-center text-muted py-4">
                                    <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                                    <p class="mb-0">No hay datos disponibles</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- REPORTE: Ventas Mensuales -->
    <div *ngIf="tipoReporte === 'ventas-mensual'">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-chart-area me-2"></i>Ventas por Mes</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Mes</th>
                                <th class="text-center">Total Ventas</th>
                                <th class="text-end">Monto Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let reporte of reporteMensualVentas">
                                <td><i class="fas fa-calendar-check text-success me-2"></i>{{reporte.mes}}</td>
                                <td class="text-center"><span class="badge bg-success">{{reporte.totalVentas}}</span>
                                </td>
                                <td class="text-end"><strong class="text-success">S/. {{reporte.montoTotal |
                                        number:'1.2-2'}}</strong></td>
                            </tr>
                            <tr *ngIf="reporteMensualVentas.length === 0">
                                <td colspan="3" class="text-center text-muted py-4">
                                    <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                                    <p class="mb-0">No hay datos disponibles</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== REPORTES DE INVENTARIO ==================== -->

    <!-- REPORTE: Inventario -->
    <div *ngIf="tipoReporte === 'inventario'">
        <!-- Estadísticas -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card text-white bg-info">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h4 class="mb-0">{{totalProductos}}</h4>
                                <small>Total de Productos</small>
                            </div>
                            <i class="fas fa-boxes fa-3x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card text-white bg-dark">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h4 class="mb-0">S/. {{valorInventario | number:'1.2-2'}}</h4>
                                <small>Valor Total del Inventario</small>
                            </div>
                            <i class="fas fa-money-bill-wave fa-3x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de Inventario -->
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-boxes me-2"></i>Inventario Completo</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th class="text-center">ID</th>
                                <th>Producto</th>
                                <th class="text-center">Stock</th>
                                <th class="text-end">Precio Unit.</th>
                                <th class="text-end">Valor Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let producto of listProductos">
                                <td class="text-center"><strong>#{{producto.id}}</strong></td>
                                <td><i class="fas fa-box text-info me-2"></i>{{producto.nombre}}</td>
                                <td class="text-center">
                                    <span
                                        [class]="producto.cantidad <= stockMinimo ? 'badge bg-danger' : 'badge bg-success'">
                                        {{producto.cantidad}}
                                    </span>
                                </td>
                                <td class="text-end">S/. {{producto.precio | number:'1.2-2'}}</td>
                                <td class="text-end"><strong>S/. {{(producto.precio * producto.cantidad) |
                                        number:'1.2-2'}}</strong></td>
                            </tr>
                            <tr *ngIf="listProductos.length === 0">
                                <td colspan="5" class="text-center text-muted py-4">
                                    <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                                    <p class="mb-0">No hay productos registrados</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- REPORTE: Stock Bajo -->
    <div *ngIf="tipoReporte === 'stock-bajo'">
        <div class="alert alert-warning" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Atención:</strong> Los siguientes productos tienen stock bajo ({{stockMinimo}} unidades o menos)
        </div>

        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Productos con Stock Bajo</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th class="text-center">ID</th>
                                <th>Producto</th>
                                <th class="text-center">Stock Actual</th>
                                <th class="text-end">Precio</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let producto of productosStockBajo" class="table-warning">
                                <td class="text-center"><strong>#{{producto.id}}</strong></td>
                                <td><i class="fas fa-box text-warning me-2"></i>{{producto.nombre}}</td>
                                <td class="text-center">
                                    <span class="badge bg-danger">{{producto.cantidad}} unidades</span>
                                </td>
                                <td class="text-end">S/. {{producto.precio | number:'1.2-2'}}</td>
                            </tr>
                            <tr *ngIf="productosStockBajo.length === 0">
                                <td colspan="4" class="text-center text-muted py-4">
                                    <i class="fas fa-check-circle fa-3x text-success mb-3 d-block"></i>
                                    <p class="mb-0">¡Excelente! No hay productos con stock bajo</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>